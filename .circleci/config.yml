version: 2.1

executors:
  node:
    resource_class: small
    docker:
      - image: cimg/node:20.5.0

commands:
  cache-cypress:
      description: 'Save Cypress cache'
      steps:
        - save_cache:
            key: v1-cypress-cache
            paths:
              - /mnt/ramdisk/.cache/Cypress
  restore-cypress:
      description: 'Restore Cypress cache'
      steps:
        - restore_cache:
            keys:
              - v1-cypress-cache
  install-deps:
    description: Install dependencies
    steps:
    - run: sudo apt-get update
    - run: sudo apt-get install -y libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb xdg-utils
    - run: wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    - run: sudo dpkg -i --force-depends google-chrome-stable_current_amd64.deb
    - run: sudo apt --fix-broken install
    - run: npm ci

jobs:  
  setup:
    executor: node
    steps:
      - checkout
      - run: node my-script.js
  test:
    parallelism: 2
    executor: node
    steps:
      - checkout
      - restore-cypress
      - install-deps
      - run: npm run test:ci
      - cache-cypress


workflows:
  common:
    jobs:
      - setup
      - test:
          requires:
            - setup
